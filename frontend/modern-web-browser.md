# [최신 브라우저의 내부 살펴보기 3 - 렌더러 프로세스의 내부 동작](https://d2.naver.com/helloworld/5237120)

> **🚀 TLDR**
>
> 렌더러 프로세스는 자신이 가지고 있는 스레드를 사용해서 HTML 문서를 화면에 렌더링한다.

(요약) 렌더러 프로세스가 HTML 문서를 받았을 때 어떤 절차를 거쳐 화면을 구성하는지 설명합니다.

> 이 과정을 효율적으로 처리하기 위해 렌더러 프로세스가 어떤 아키텍처를 가지고 있는지 살펴보고, 웹 개발자가 고려하면 좋을 내용을 소개합니다.

(역할) 렌더러 프로세스의 주요 역할은 HTML과 CSS, JavaScript를 사용자와 상호작용을 할 수 있는 웹 페이지로 변환하는 것이다.

> 렌더러 프로세스는 탭 내부에서 발생하는 모든 작업을 담당한다. 렌더러 프로세스의 메인 스레드가 브라우저로 전송된 대부분의 코드를 처리한다. 간혹 웹 워커나 서비스 워커를 사용하는 경우에는 워커 스레드가 JavaScript 코드의 일부를 처리한다. 웹 페이지를 효율적이고 부드럽게 렌더링하기 위해 별도의 컴포지터 스레드와 래스터 스레드가 렌더러 프로세스에서 실행된다.

(구성) 렌더러 프로세스에는 메인 스레드, 워커 스레드, 컴포지터 스레드, 래스터 스레드가 있다.

> 여기서 컴포지터 스레드와 래스터 스레드는 웹 페이지를 부드럽게 렌더링하기 위해 실행된다.

---

## 파싱 - DOM 구축

> **🚀 TLDR**
>
> 렌더러 프로세스는 HTML 데이터를 받으면 메인 스레드가 HTML 문자열을 파싱한다. HTML 문서에 연결된 이미지, CSS 파일, JS 파일 등 하위 리소스를 로딩할 때는 (HTML을 파싱하는 메인 스레드가 실행된 동시에) 프리로드 스캐너도 같이 실행되어 `<img>` 또는 `<link>` 태그가 있으면 브라우저 프로세스의 네트워크 스레드에 요청을 보낸다. `<script>` 태그를 만나면 파싱을 중지하고 자바스크립트 파일을 전부 로딩하고 실행까지 완료한 다음에야 다시 파싱을 재개한다.

(01) 렌더러 프로세스가 HTML 데이터를 수신하기 시작하면 메인 스레드가 HTML 문자열을 파싱해서 DOM을 구축한다.

> 페이지를 이동하는 내비게이션 실행 메시지를 렌더러 프로세스가 받고 HTML 데이터를 수신하기 시작하면 렌더러 프로세스의 메인 스레드는 문자열(HTML)을 파싱해서 DOM(document object model)으로 변환하기 시작한다.

(01-a) 하위 리소스(subresource) 로딩. HTML 파일에 연결되어 있는 외부 리소스를 로딩하는 속도를 높이기 위해 프리로드(Preload) 스캐너가 동시에 실행된다. 프리로드 스캐너는 `<img>` 또는 `<link>` 태그가 있으면 브라우저 프로세스의 네트워크 스레드에 요청을 보낸다.

> 웹 사이트는 일반적으로 이미지, CSS, JavaScript와 같은 외부 리소스를 사용한다. 이러한 파일은 네트워크나 캐시에서 로딩해야 한다. DOM을 구축하기 위해 파싱하는 동안 이런 리소스를 만날 때마다 메인 스레드가 하나하나 요청할 수도 있을 것이다. 하지만 속도를 높이기 위해 '프리로드(Preload) 스캐너'가 동시에 실행된다. HTML 문서에`<img>` 또는`<link>` 와 같은 태그가 있으면 프리로드 스캐너는 HTML 파서가 생성한 토큰을 확인하고 브라우저 프로세스의 네트워크 스레드에 요청을 보낸다.

(01-b) 파싱 일시중지. `<script>` 태그를 만나면 HTML 파서는 파싱을 일시 중지한 다음 자바스크립트 코드를 로딩하고 자바스크립트의 실행이 끝나면 다시 파싱을 재개한다. 왜냐하면 자바스크립트는 DOM 구조 전체를 바꿀 수 있기 때문이다.

> `<script>` 태그를 만나면 HTML 파서는 HTML 문서의 파싱을 일시 중지한 다음 JavaScript 코드를 로딩하고 파싱해 실행해야 한다. 왜 그럴까? JavaScript는 DOM 구조 전체를 바꿀 수 있는 `document.write()` 메서드와 같은 것을 사용해 문서의 모양을 변경할 수 있기 때문이다(HTML 명세의 "Overview of the parsing model"(파싱 모델 개요)에 있는 다이어그램이 이 상황을 잘 표현하고 있다). HTML 파싱을 재개하기 전에 HTML 파서는 JavaScript의 실행이 끝나기를 기다려야 한다. JavaScript를 실행할 때 어떤 일이 발생하는지 궁금하다면 "JavaScript engine fundamentals: Shapes and Inline Caches"(JavaScirpt 엔진의 기본: 형태와 인라인 캐시) 글의 영상과 내용을 참고한다.

> 웹 개발자가 브라우저에 리소스 로딩에 대한 힌트를 보내는 방법에는 여러 가지가 있다. JavaScript에서 `document.write()` 메서드를 사용하지 않는다면`<script>` 태그에 `async` 속성이나 `defer` 속성을 추가할 수 있다. 이 속성이 있으면 브라우저가 JavaScript 코드를 비동기적으로 로딩하고 실행하면서 HTML 파싱을 막지 않는다. JavaScript 모듈을 사용할 수도 있다.`<link rel="preload">`는 현재 내비게이션을 실행하기 위해 리소스가 반드시 필요하다는 것을 브라우저에 알려서 리소스를 가능한 한 빨리 다운로드하려는 경우에 사용할 수 있다. 브라우저에 힌트를 주는 방법에 관해 더 알고 싶다면 "Resource Prioritization – Getting the Browser to Help You"(리소스 우선순위 지정 - 브라우저의 도움 받기)를 참고한다.

---

To be continued...
